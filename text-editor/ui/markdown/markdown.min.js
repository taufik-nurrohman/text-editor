/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.4.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Markdown=function(e,t){function v(e){return y(e.replace(/\s+/g," "))}function x(e){return m(v(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function k(e){return m(v(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=TE.ui.HTML||TE.ui,i=n(e,{extra:0,auto_p:0,auto_close:{"`":"`","*":"*",_:"_","~":"~"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},note:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:["~~"],h1:["=","#"],h2:["-","##"],h3:["###"],h4:["####"],h5:["#####"],h6:["######"],blockquote:[">"],code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),r=i.ui,o="	",f=TE.is,s=f.o,l=function(e){return!f.x(e)},a=f.s,u=i._,c=u.edge,d=u.x,p=u.extend,b=u.format,h=u.i,g=u.pattern,m=u.replace,y=u.trim;i.update(t,0),i.type="Markdown";var w=i.config,$=w.extra,E=w.formats,T=w.languages,_=w.states,L=w.tab,z=T.placeholders,O="( +["+d(E.ul).join("")+"] )",C=0;return $||(w["advance_pre,code"]=0),i.mark=function(e,t,n,r){s(e)||(e=[e]),l(n)||(n=" "),l(r)||(r="");var o=i.h,f=i[0]().$(),a=e[0]+r,u=r+(l(e[1])?e[1]:e[0]),c=f.value,p=d(a),b=d(u),h=g("^"+p+"([\\s\\S]*?)"+b+"$"),m=g(p+"$"),y=g("^"+b),v=f.before,x=f.after;return c?n=!1:i.insert(z[""]),i.toggle(t?!h.test(c):!m.test(v)&&!y.test(x),[function(e){e.unwrap(a,u,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(x)?"":n).wrap(a,u,t)},function(e){e.unwrap(a,u,t)}])[o]()},p(r.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:$?{click:function(e,t){return t.i().mark(E.s[0]),!1}}:0,a:{click:function(e,t){var d,p,b,h,g,m,v,n=t.$(),i=n.before,o=n.value,f=n.after,s=t.get(),l=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",a=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=T.modals.a,c=u.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(o))return t.tidy(" ").mark(["<",">"],1),!1;for(v in a)v=" "+y(a[v]).replace(/^\[|\]:$/g,""),_.a[v]=1;return d=_.a,r.prompt(u.title[0],c,0,function(e,t,s){var v=""===s;s=k(s),t[0](),d[s]?(t.trim(y(i)?" ":"",/^\n+ {0,3}\*?\[/.test(f)?!1:" ").mark(["[","]["+s+"]"],0,!1),h=a.indexOf(" ["+s+"]:"),-1===h&&1!==d[s]&&(n=t.$(),i=n.before,g=n.start,m=n.end,t.set(i+o+y(n.after,1)+l+" ["+(s||y(o)||z[""])+"]: "+(v?"":d[s][0]+(d[s][1]?' "'+d[s][1]+'"':""))).select(g,m),v&&t.focus(1).insert(c))):(p=s,r.prompt(u.title[1],u.placeholder[1],0,function(e,t,n){b=x(n),o||t.insert(z[""]),t.i().trim(y(i)?" ":"",y(f)?/^\n+ {0,3}\*?\[/.test(f)?"\n\n ":" ":"").wrap("[","]("+p+(b?' "'+b+'"':"")+")")},0,0,"a[title]")),t[1]()},0,0,"a[href]").record(),!1}},img:{click:function(e,t){var b,h,g,m,v,w,$,n=t.$(),i=n.value,o=i,f=n.before,s=n.after,l=t.get(),a=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",u=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=T.modals.img,d=/^\n* {0,3}\[.+?\]:/.test(s)?" ":"",p=y(s);for($ in u)$=" "+y(u[$]).replace(/^\[|\]:$/g,""),!_.img[$]&&(_.img[$]=1);return b=_.img,r.prompt(c.title[0],c.placeholder[0],1,function(e,t,s){s=k(s),h=s,o||(o=h.split(/[\/\\\\]/).pop()),o=x(o),t[0]().trim(y(f)?"\n\n":"",d),b[s]?(t.insert("!["+o+"]["+s+"]\n\n",0,1),d&&t.select(t.$().start),m=u.indexOf(" ["+s+"]:"),-1===m&&(n=t.$(),f=n.before,v=n.start,w=n.end,t.set(f+i+n.after+(p?a:"")+" ["+s+"]: "+b[s][0]+(b[s][1]?' "'+b[s][1]+'"':"")).select(v,w))):r.prompt(c.title[1],c.placeholder[1],0,function(e,t,n){g=x(n),t.insert("!["+o+"]("+h+(g?' "'+g+'"':"")+")\n\n",0,1),d&&t.select(t.$().start)},0,0,"img[title]"),t[1]()},0,0,"img[src]"),!1}},sub:0,sup:0,abbr:$?{click:function(t,n){var i=n.$(),o=y(i.value),f=T.modals.abbr,s=n.get(),l=v(o||z[""]),a=/^ {0,3}\*\[.+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",u=s.match(/^ {0,3}\*\[.+?\]:/gm)||[],c=_.abbr,d=0;for(d in u)u[d]=" "+y(u[d]);return d=u.indexOf(" *["+l+"]:"),o&&-1!==d?(d=s.indexOf(u[d])+3,n.select(d,d+l.length),e.scrollTop=n.$(1).caret[0].y,!1):(r.prompt(f.title,c[l]||f.placeholder,!c[o],function(e,t,n,r){if(n=x(n),t[0]().set(y(t.get(),1)+(i.before||o?a:"")+" *["+l+"]: ").focus(1).insert(n||r),l===z[""]){var f=t.$().start;t.select(f-3-l.length,f-3)}t[1]()},0,0,"abbr[title]").record(),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(z[""]).scroll(2),!1)}},br:{click:function(e,t){var n=w.advance_br;return!a(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0).scroll(1),!1}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){C>5?C=0:C++;var n=t.$(),i=w["advance_h1,h2"],r="\\s?["+d(E.h1[0]+E.h2[0])+"]+\\s*",o=d(E.h1[1]),f=n.before.replace(g("["+o+"\\s]+$"),""),s=v(n.value).replace(g("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(g(r+"$"),"")||z[""],l=n.after.replace(g("^["+o+"\\s]+"),"").replace(g("^"+r),""),a=["",E.h1[i?0:1],E.h2[i?0:1],E.h3[0],E.h4[0],E.h5[0],E.h6[0]];return t[0]().set(f+s+l).select(f.length,(f+s).length).tidy("\n\n"),0===C||(3>C&&i?t.wrap("","\n"+s.replace(/./g,a[C])):t.wrap(a[C]+" ",w["close_h1,h2,h3,h4,h5,h6"]?" "+a[C]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),i=n.value,r=E.blockquote[0];return i===z[""]?(t.select(),!1):i?(t.tidy(g(r+" $").test(n.before)?!1:"\n\n")[g("^"+r).test(i)?"outdent":"indent"](r+" "),!1):(t[0]().tidy("\n\n").insert(r+" ",0).insert(z[""])[1](),!1)}},"pre,code":{click:function(e,t){var u,c,p,n=t.$(),i=n.before,r=n.value,f=w["advance_pre,code"],s=E.code,l=s[1]||s[0];return l=l+l+l,!a(f)&&f?f=l:a(f)&&-1!==f.indexOf("%")&&(f=b(f,[l])),u="( {4,}|\\t"+(a(f)?"|"+d(f):"")+")",g("(^|\\n)"+u+"?$").test(i)?f?(t.mark([f,f.split(/\s+/)[0]],0,"\n\n","\n"),!1):(f=L===o?o:"    ",r?r===z[""]&&g(u+"$").test(i)?(t.select(n.start-f.length,n.end),!1):(t.tidy("\n\n")[g("^"+u).test(r)?"outdent":"indent"](f),!1):(t[0]().tidy("\n\n"),c=t.$().start,p=f+z[""],t.insert(p).select(c+f.length,c+p.length)[1](),!1)):(t.mark(s[0]),!1)}},ul:{click:function(e,t){var y,n=t.$(),i=n.value,r=n.before,o=n.after,f=E.ul[0],s=E.ol[0],l=d(f),a=b(d(s),["\\d+"]),u=g("(^|\\n)([\\t ]*) "+l+" (.*)$"),c=g("^(.*) "+l+" ","gm"),p=g("(^|\\n)([\\t ]*) "+a+" (.*)$"),h=g("^(.*) "+a+" ","gm"),m=z[""];return i?(i===m?t.select():h.test(i)?t.replace(h,"$1 "+f+" "):c.test(i)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+f+" $2"),!1):o&&r&&("\n"!==o[0]||"\n"!==r.slice(-1))?(y=p.test(r)?r.replace(p,"$1$2 "+f+" $3"):u.test(r)?r.replace(u,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(y+o).select(y.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",0).insert(m)[1](),!1)}},ol:{click:function(e,t){var x,n=t.$(),i=n.value,r=n.before,o=n.after,f=E.ul[0],s=E.ol[0],l=b(s,[1]),a=d(f),u=b(d(s),["\\d+"]),c=g("(^|\\n)([\\t ]*) "+a+" (.*)$"),p=g("^(.*) "+a+" ","gm"),h=g("(^|\\n)([\\t ]*) "+u+" (.*)$"),m=g("^(.*) "+u+" ","gm"),y=z[""],v=0;return i?(i===y?t.select():p.test(i)?t.replace(p,function(e,t,n){return++v,t+" "+b(s,[v])+" "}):m.test(i)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+b(s,[v])+" "+n}),!1):o&&r&&("\n"!==o[0]||"\n"!==r.slice(-1))?(x=c.test(r)?r.replace(c,"$1$2 "+l+" $3"):h.test(r)?r.replace(h,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(x+o).select(x.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",0).insert(y)[1](),!1)}},table:$?function(e,t){var a,u,d,n=_.tr,i=_.td,o=T.modals.table,f=T.placeholders.table,s=b(f[0],[1,1]),l=[];return t[0]().$().value===s?(t.select(),!1):(r.prompt(o.title[0],o.placeholder[0],0,function(e,t,p,g){u=c(h(p)||g,i[0],i[1]),r.prompt(o.title[1],o.placeholder[1],0,function(e,t,i,r){d=c(h(i)||r,n[0],n[1]);var o,p,g,m,y,v;for(o=0;d>o;++o){for(a="|",p=0;u>p;++p)a+=" "+b(f[1],[o+1,p+1])+" |";l.push(a)}for(l=l.join("\n"),a="|",g=0;u>g;++g)a+=" "+b(f[0],[g+1,g+1]).replace(/./g,"-")+" |";for(l=a+"\n"+l,a="|",m=0;u>m;++m)a+=" "+b(f[0],[1,m+1])+" |";l=a+"\n"+l,w.close_tr||(l=l.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(l),y=t.$(),v=y.start+y.value.indexOf(s),t.select(v,v+s.length)[1]()},0,0,"table>tr")},0,0,"table>td"),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0).scroll(2),!1}},note:$?{i:"thumb-tack",click:function(t,n){var d,i=n.$(),o=i.before,f=i.after,s=T.modals.note,l=n.get(),a=/^ {0,3}\[\^.+?\]:/.test(y(l).split("\n").pop())?"\n":"\n\n",u=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in u)u[c]=" "+y(u[c]);return c=u.length+1,r.prompt(s.title,i.value||c,0,function(t,n,i,r){i=y(i||r)||c,d=u.indexOf(" [^"+i+"]:"),-1!==d?(c=l.indexOf(u[d])+3,n.select(c,c+i.length),e.scrollTop=n.$(1).caret[0].y):n.trim(y(o)?" ":"",!y(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("[^"+i+"]").set(y(n.get(),1)+a+" [^"+i+"]: ").focus(1).insert(z[""])},0,0,"note[id]"),!1}}:0}),p(r.keys,{enter:function(e,t){var n=t.$(),i=z[""],r=E.blockquote[0],f=(E.ul[0],E.ol[0]),s=b(d(f),["\\d+"]),l="(("+d(r)+" )+|"+O+"| +("+s+") )",a=g("^"+l+".*$","gm").exec(n.before.split("\n").pop());if(a){if(a[0]===a[1])return t[0]().insert("").outdent(g(l))[1](),!1;if(g("\\s*"+s+"\\s*").test(a[1])){var u=h(y(a[1]));return t[0]().insert("\n"+a[1].replace(/\d+/,u+1),0).insert(i).scroll(1)[1](),!1}return t[0]().insert("\n"+a[1],0).insert(i).scroll(1)[1](),!1}},"shift+tab":function(e,t){var y,n=t.$(),i=n.before,o=n.value,f=n.after,s=z[""],l=E.ol[0],a=d(l),u=b(a,["\\d+"]),c=d(E.blockquote[0]),p=g("  "+O+"$"),h=g("   ( ?"+u+" )$"),m="("+c+" |"+O+"| +"+u+" )";if(o&&o!==s){if(o&&(y=o.match(g("(^|\\n)"+m,"g"))))return t.outdent(g(m)),!1}else{if(y=i.match(g(c+" $")))return t[0]().insert("").outdent(y[0]).insert(o)[1](),!1;if(y=i.match(p))return i=i.replace(p,"$1"),t.set(i+o+f).select(i.length,(i+o).length),!1;if(y=i.match(h))return i=i.replace(h,"$1"),t.set(i+o+f).select(i.length,(i+o).length),!1}return r.tools.outdent.click(e,t)},tab:function(e,t){var m,n=t.$(),i=n.before,o=n.value,f=n.after,s=z[""],l=E.ol[0],a=E.blockquote[0],u=d(l),c=d(a),p=g(O+"$"),h=g(" ?"+b(u,["\\d+"])+" $");if(o&&o!==s){if(g("^"+c+" ").test(o))return t.indent(a+" "),!1}else{if(m=i.match(g(c+" $")))return t.insert(m[0],0),!1;if(m=i.match(p))return i=i.replace(p,"  $1"),t.set(i+o+f).select(i.length,(i+o).length),!1;if(m=i.match(h))return i=i.replace(h,"    "+b(l,[1])+" "),t.set(i+o+f).select(i.length,(i+o).length),!1}return r.tools.indent.click(e,t)},"control+arrowdown":"note","control+arrowup":"note"}),i.update({},0)};